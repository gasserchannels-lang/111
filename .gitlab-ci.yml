stages:
  - analyze
  - report
  - fix
  - test
  - verify
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - vendor/
    - node_modules/
    - storage/logs/

variables:
  PHP_MEMORY_LIMIT: 1G
  COMPOSER_MEMORY_LIMIT: 1G

# ========================================
# ğŸ” Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø§ÙƒØªØ´Ø§Ù
# ========================================
analyze_code_quality:
  stage: analyze
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  script:
    - cp .env.example .env
    - composer install --prefer-dist --no-progress --no-ansi --ignore-platform-req=ext-zip --no-scripts
    - php artisan key:generate
    - php artisan config:cache
    - php artisan package:discover --ansi
    - npm install
    - npm run build
    - echo "ğŸ” Starting Code Quality Analysis..."
    - composer audit --format=json > storage/logs/composer-audit.json || true
    - ./vendor/bin/phpstan analyse --memory-limit=1G --error-format=json > storage/logs/phpstan.json || true
    - ./vendor/bin/phpmd app text cleancode,codesize,controversial,design,naming,unusedcode --reportfile storage/logs/phpmd.xml || true
    - ./vendor/bin/pint --test --json > storage/logs/pint.json || true
  artifacts:
    paths:
      - vendor/
      - node_modules/
      - public/
      - .env
      - storage/logs/
    expire_in: 1 hour

analyze_security:
  stage: analyze
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  needs:
    - job: analyze_code_quality
      artifacts: true
  script:
    - echo "ğŸ”’ Starting Security Analysis..."
    - composer audit --format=json > storage/logs/security-audit.json || true
    - php artisan test tests/Security/ --configuration=phpunit.testing.xml --log-junit=storage/logs/security-tests.xml || true
  artifacts:
    paths:
      - storage/logs/
    expire_in: 1 hour

analyze_performance:
  stage: analyze
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  needs:
    - job: analyze_code_quality
      artifacts: true
  script:
    - echo "âš¡ Starting Performance Analysis..."
    - php artisan test tests/Performance/ --configuration=phpunit.testing.xml --log-junit=storage/logs/performance-tests.xml || true
  artifacts:
    paths:
      - storage/logs/
    expire_in: 1 hour

# ========================================
# ğŸ“Š Ù…Ø±Ø­Ù„Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
# ========================================
generate_reports:
  stage: report
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  needs:
    - job: analyze_code_quality
      artifacts: true
    - job: analyze_security
      artifacts: true
    - job: analyze_performance
      artifacts: true
  script:
    - echo "ğŸ“Š Generating Comprehensive Reports..."
    - composer install --prefer-dist --no-progress --no-ansi --ignore-platform-req=ext-zip --no-scripts
    - php artisan key:generate
    - php artisan config:cache
    - php artisan package:discover --ansi
    - mkdir -p reports
    - echo "# ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„" > reports/analysis-report.md
    - echo "## ğŸ” ØªØ­Ù„ÙŠÙ„ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯" >> reports/analysis-report.md
    - echo "- PHPStan: $(cat storage/logs/phpstan.json | jq '.totals.errors' 2>/dev/null || echo 'N/A')" >> reports/analysis-report.md
    - echo "- PHPMD: $(cat storage/logs/phpmd.xml | grep -c 'violation' 2>/dev/null || echo 'N/A')" >> reports/analysis-report.md
    - echo "- Laravel Pint: $(cat storage/logs/pint.json | jq '.changes' 2>/dev/null || echo 'N/A')" >> reports/analysis-report.md
    - echo "## ğŸ”’ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§Ù†" >> reports/analysis-report.md
    - echo "- Composer Audit: $(cat storage/logs/composer-audit.json | jq '.advisories | length' 2>/dev/null || echo 'N/A')" >> reports/analysis-report.md
    - echo "## âš¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡" >> reports/analysis-report.md
    - echo "- Performance Tests: $(cat storage/logs/performance-tests.xml | grep -c 'testcase' 2>/dev/null || echo 'N/A')" >> reports/analysis-report.md
    - echo "ğŸ“‹ Reports generated successfully"
  artifacts:
    paths:
      - storage/logs/
      - reports/
    expire_in: 1 day

# ========================================
# ğŸ”§ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
# ========================================
auto_fix_code_style:
  stage: fix
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  needs:
    - job: generate_reports
      artifacts: true
  script:
    - echo "ğŸ”§ Starting Auto-Fix Process..."
    - composer install --prefer-dist --no-progress --no-ansi --ignore-platform-req=ext-zip --no-scripts
    - php artisan key:generate
    - php artisan config:cache
    - php artisan package:discover --ansi
    - echo "ğŸ¨ Auto-fixing code style with Laravel Pint..."
    - ./vendor/bin/pint --dirty
    - echo "âœ… Code style auto-fix completed"
  artifacts:
    paths:
      - vendor/
      - node_modules/
      - public/
      - .env
    expire_in: 1 hour

auto_fix_dependencies:
  stage: fix
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  needs:
    - job: auto_fix_code_style
      artifacts: true
  script:
    - echo "ğŸ“¦ Auto-fixing dependencies..."
    - composer update --prefer-dist --no-progress --no-ansi --ignore-platform-req=ext-zip --no-scripts
    - composer audit --fix || true
    - echo "âœ… Dependencies auto-fix completed"
  artifacts:
    paths:
      - vendor/
      - node_modules/
      - public/
      - .env
    expire_in: 1 hour

# ========================================
# ğŸ§ª Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„ØªØ¬Ø±Ø¨Ø©
# ========================================
test_unit:
  stage: test
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    DB_HOST: mysql
  needs:
    - job: auto_fix_dependencies
      artifacts: true
  script:
    - echo "ğŸ§ª Running Unit Tests..."
    - until mysqladmin ping -h mysql --silent; do echo "Waiting for MySQL..."; sleep 2; done
    - php artisan migrate --force
    - php artisan test tests/Unit/ --configuration=phpunit.testing.xml --log-junit=storage/logs/unit-tests.xml
  artifacts:
    when: always
    reports:
      junit: storage/logs/unit-tests.xml

test_ai:
  stage: test
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  needs:
    - job: auto_fix_dependencies
      artifacts: true
  script:
    - echo "ğŸ¤– Running AI Tests..."
    - php artisan test tests/AI/ --configuration=phpunit.testing.xml --log-junit=storage/logs/ai-tests.xml
  artifacts:
    when: always
    reports:
      junit: storage/logs/ai-tests.xml

test_integration:
  stage: test
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    DB_HOST: mysql
  needs:
    - job: auto_fix_dependencies
      artifacts: true
  script:
    - echo "ğŸ”— Running Integration Tests..."
    - until mysqladmin ping -h mysql --silent; do echo "Waiting for MySQL..."; sleep 2; done
    - php artisan migrate --force
    - php artisan test tests/Integration/ --configuration=phpunit.testing.xml --log-junit=storage/logs/integration-tests.xml
  artifacts:
    when: always
    reports:
      junit: storage/logs/integration-tests.xml

test_e2e:
  stage: test
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip chromium
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    DB_HOST: mysql
    APP_URL: http://localhost:8000
  needs:
    - job: auto_fix_dependencies
      artifacts: true
  script:
    - echo "ğŸŒ Running E2E Tests..."
    - until mysqladmin ping -h mysql --silent; do echo "Waiting for MySQL..."; sleep 2; done
    - php artisan migrate --force
    - php artisan serve --host=0.0.0.0 --port=8000 &
    - sleep 10
    - php artisan dusk --configuration=phpunit.testing.xml --log-junit=storage/logs/e2e-tests.xml
  artifacts:
    when: always
    reports:
      junit: storage/logs/e2e-tests.xml

test_links:
  stage: test
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    DB_HOST: mysql
  needs:
    - job: auto_fix_dependencies
      artifacts: true
  script:
    - echo "ğŸ”— Running Link Checker Tests..."
    - until mysqladmin ping -h mysql --silent; do echo "Waiting for MySQL..."; sleep 2; done
    - php artisan migrate --force
    - php artisan test tests/Feature/LinkCheckerTest.php --configuration=phpunit.testing.xml --log-junit=storage/logs/link-checker-tests.xml
    - php artisan links:check --all
  artifacts:
    when: always
    reports:
      junit: storage/logs/link-checker-tests.xml
    paths:
      - storage/logs/link-check-report.json

# ========================================
# âœ… Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
# ========================================
verify_quality:
  stage: verify
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  needs:
    - job: test_unit
      artifacts: true
    - job: test_ai
      artifacts: true
    - job: test_integration
      artifacts: true
  script:
    - echo "âœ… Final Quality Verification..."
    - composer install --prefer-dist --no-progress --no-ansi --ignore-platform-req=ext-zip --no-scripts
    - php artisan key:generate
    - php artisan config:cache
    - php artisan package:discover --ansi
    - echo "ğŸ” Re-running quality checks..."
    - ./vendor/bin/phpstan analyse --memory-limit=1G
    - ./vendor/bin/phpmd app text cleancode,codesize,controversial,design,naming,unusedcode
    - ./vendor/bin/pint --test
    - composer audit
    - echo "ğŸ‰ All quality checks passed!"
  artifacts:
    paths:
      - storage/logs/
    expire_in: 1 day

verify_security:
  stage: verify
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  needs:
    - job: verify_quality
      artifacts: true
  script:
    - echo "ğŸ”’ Final Security Verification..."
    - composer install --prefer-dist --no-progress --no-ansi --ignore-platform-req=ext-zip --no-scripts
    - php artisan key:generate
    - php artisan config:cache
    - php artisan package:discover --ansi
    - echo "ğŸ›¡ï¸ Re-running security tests..."
    - php artisan test tests/Security/ --configuration=phpunit.testing.xml
    - composer audit
    - echo "ğŸ‰ All security checks passed!"
  artifacts:
    paths:
      - storage/logs/
    expire_in: 1 day

# ========================================
# ğŸš€ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)
# ========================================
deploy_staging:
  stage: deploy
  image: php:8.2-cli
  before_script:
    - apt-get update && apt-get install -y curl unzip
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  needs:
    - job: verify_security
      artifacts: true
  script:
    - echo "ğŸš€ Deploying to Staging..."
    - echo "âœ… All stages completed successfully!"
    - echo "ğŸ‰ Project is ready for deployment!"
  when: manual
  only:
    - main